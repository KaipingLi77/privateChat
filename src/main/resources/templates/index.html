<!DOCTYPE HTML>
<html xmlns:th="http://www.thymeleaf.org">
<head> 
    <title>Getting Started: Serving Web Content</title> 
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <!-- Latest compiled and minified CSS -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@3.4.1/dist/css/bootstrap.min.css" integrity="sha384-HSMxcRTRxnN+Bdg0JdbxYKrThecOKuH5zCYotlSAcp1+c8xmyTe9GYg1l9a69psu" crossorigin="anonymous">
<link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css" rel="stylesheet">
<link th:href="@{/css/main.css}" rel="stylesheet" />
<script src="https://code.jquery.com/jquery-3.7.0.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@3.4.1/dist/js/bootstrap.min.js" integrity="sha384-aJ21OjlMXNL5UyIl/XNwTMqvzeRMZH2w8c5cRVpzpU8Y5bApTppSuUkhZXN0VxHd" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.nicescroll/3.6.8-fix/jquery.nicescroll.min.js"></script>
<script>
    $(function(){
        var nameList = [
                'Time','Past','Future','Dev',
                'Fly','Flying','Soar','Soaring','Power','Falling',
                'Fall','Jump','Cliff','Mountain','Rend','Red','Blue',
                'Green','Yellow','Gold','Demon','Demonic','Panda','Cat',
                'Kitty','Kitten','Zero','Memory','Trooper','XX','Bandit',
                'Fear','Light','Glow','Tread','Deep','Deeper','Deepest',
                'Mine','Your','Worst','Enemy','Hostile','Force','Video',
                'Game','Donkey','Mule','Colt','Cult','Cultist','Magnum',
                'Gun','Assault','Recon','Trap','Trapper','Redeem','Code',
                'Script','Writer','Near','Close','Open','Cube','Circle',
                'Geo','Genome','Germ','Spaz','Shot','Echo','Beta','Alpha',
                'Gamma','Omega','Seal','Squid','Money','Cash','Lord','King',
                'Duke','Rest','Fire','Flame','Morrow','Break','Breaker','Numb',
                'Ice','Cold','Rotten','Sick','Sickly','Janitor','Camel','Rooster',
                'Sand','Desert','Dessert','Hurdle','Racer','Eraser','Erase','Big',
                'Small','Short','Tall','Sith','Bounty','Hunter','Cracked','Broken',
                'Sad','Happy','Joy','Joyful','Crimson','Destiny','Deceit','Lies',
                'Lie','Honest','Destined','Bloxxer','Hawk','Eagle','Hawker','Walker',
                'Zombie','Sarge','Capt','Captain','Punch','One','Two','Uno','Slice',
                'Slash','Melt','Melted','Melting','Fell','Wolf','Hound',
                'Legacy','Sharp','Dead','Mew','Chuckle','Bubba','Bubble','Sandwich','Smasher','Extreme','Multi','Universe','Ultimate','Death','Ready','Monkey','Elevator','Wrench','Grease','Head','Theme','Grand','Cool','Kid','Boy','Girl','Vortex','Paradox'
            ]
    var finalName = generate();
    var finalNameIconMap = new Map();    
    $(".chat").niceScroll();
    var mySocket = new WebSocket("ws://localhost:7070/chatroom/"+finalName);

    mySocket.onopen = function(e){
        console.log(e);
    }

    $(".answer-add:first").find("input").on("keyup",function(e){
        var code = e.key;
        var input = $(".answer-add:first").find("input");
        var value = input.val();
        if(code==="Enter"){
            sendMsg(value,finalName);
        }
    })


    mySocket.onmessage = function(e){
        var data = e.data;
        const msg = JSON.parse(data);
        if(msg.type == "onlineUsers"){
           updateOnlineUser(msg.OnlineUser);
        }else if(msg.type == "system"){
            systemMsg(msg.content);
        }else{
            updateMsg(msg.msg,msg.nickName);
        }
        console.log(e.data);
    }
        
            function generate() {
               var finalName = nameList[Math.floor( Math.random() * nameList.length )];
               return finalName;
            }

    function addUser(name){
        var userDom = document.createElement("div");
        var userName = document.createElement("div");
        var iconDom = document.createElement("div");
        var imgNode = document.createElement("img");
        var statusNode = document.createElement("div");
        var moodDom = document.createElement("div");
        var ranInt = Math.floor(Math.random() * 7) + 1;
        imgNode.src = "https://bootdey.com/img/Content/avatar/avatar" + ranInt +".png";
        iconDom.classList.add("avatar");
        statusNode.classList.add("status","online");
        iconDom.appendChild(imgNode)
        iconDom.appendChild(statusNode);
        userDom.classList.add("user");
        userName.classList.add("name");
        userName.innerText = name;
        userDom.appendChild(iconDom);
        userDom.append(userName);
        moodDom.classList.add("mood");
        moodDom.innerText="Hello World!";
        userDom.append(moodDom);
        document.getElementById("userList").append(userDom);
        finalNameIconMap.set(finalName,ranInt);
        console.log(finalNameIconMap);

        
    }

    function updateMsg(msg,nickName){
        var templateCode = `
        <div class="answer ${nickName === finalName ? 'right' : 'left'}">
                <div class="avatar">
                  <img src="https://bootdey.com/img/Content/avatar/avatar${finalNameIconMap.get(finalName)}.png" alt="User name">
                  <div class="status offline"></div>
                </div>
                <div class="name">${nickName}</div>
                <div class="text">
                  ${msg}
                </div>
                <div class="time">5 min ago</div>
              </div>
        `;
        $(".answer-add:first").before(templateCode);

    }

    function updateOnlineUser(onlineUser){
        document.getElementById("userList").innerHTML = "";
        $.each(onlineUser,function(index,name){
            addUser(name);
        });
    }

    function systemMsg(msg){
        var template = `<div class="answer" style="width:100% !important">
            <div class="" style="display:flex;justify-content: space-around;color:gray">
        ${msg}
    </div>
    </div>
            `;
    $(".answer-add:first").before(template);
    }

    function sendMsg(msg,nickName){
        var data = new Object();
        data.msg = msg;
        data.nickName = nickName;
        mySocket.send(JSON.stringify(data));
    }
}) 
</script>
</head>
<div class="container">
<div class="content container-fluid bootstrap snippets bootdey">
      <div class="row row-broken">
        <div class="col-sm-3 col-xs-12">
          <div class="col-inside-lg decor-default chat" style="overflow: hidden; outline: none;" tabindex="5000">
            <div class="chat-users">
              <h6>online</h6>
              <div id="userList"></div>
            </div>
          </div>
        </div>
        <div class="col-sm-9 col-xs-12 chat" style="overflow: hidden; outline: none;" tabindex="5001">
          <div class="col-inside-lg decor-default">
            <div class="chat-body">
              <h6>Mini Chat</h6>
              <div class="answer-add">
                <input placeholder="Write a message">
                <span class="answer-btn answer-btn-1"></span>
                <span class="answer-btn answer-btn-2"></span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
 </div>
</html>